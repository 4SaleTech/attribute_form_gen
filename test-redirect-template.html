<!DOCTYPE html>
<html>
<head>
    <title>Test Redirect Template</title>
    <script type="module">
        // Simulate the template evaluation function
        function evaluateTemplate(template, context) {
            if (!template.includes('{{')) {
                return template;
            }
            const templateRegex = /\{\{\.([\w.]+)\}\}/g;
            return template.replace(templateRegex, (match, varName) => {
                let value = context[varName];
                if (value === undefined && varName.includes('.')) {
                    const parts = varName.split('.');
                    value = context;
                    for (const part of parts) {
                        if (value && typeof value === 'object') {
                            value = value[part];
                        } else {
                            value = undefined;
                            break;
                        }
                    }
                }
                let strValue = '';
                if (value === null || value === undefined) {
                    strValue = '';
                } else if (typeof value === 'string') {
                    strValue = value;
                } else if (typeof value === 'number') {
                    strValue = String(value);
                } else if (typeof value === 'boolean') {
                    strValue = value ? 'true' : 'false';
                } else if (Array.isArray(value)) {
                    strValue = value.map(v => String(v)).join(',');
                } else if (typeof value === 'object') {
                    if (value.e164) {
                        strValue = value.e164;
                    } else if (value.value === 'other' && value.other) {
                        strValue = value.other;
                    } else if (value.value) {
                        strValue = String(value.value);
                    } else if (typeof value.lat === 'number' && typeof value.lng === 'number') {
                        strValue = `${value.lat.toFixed(6)},${value.lng.toFixed(6)}`;
                    } else if (value.url) {
                        strValue = value.url;
                    } else {
                        strValue = JSON.stringify(value);
                    }
                } else {
                    strValue = String(value);
                }
                return strValue;
            });
        }

        function encodeTemplateInURL(url, context) {
            if (!url.includes('{{')) {
                return url;
            }
            try {
                const [base, queryString] = url.split('?');
                if (!queryString) {
                    return evaluateTemplate(base, context);
                }
                const evaluatedBase = evaluateTemplate(base, context);
                const queryParams = queryString.split('&');
                const encodedParams = [];
                for (const param of queryParams) {
                    const [key, value] = param.split('=');
                    if (value && value.includes('{{')) {
                        const evaluatedValue = evaluateTemplate(value, context);
                        encodedParams.push(`${key}=${encodeURIComponent(evaluatedValue)}`);
                    } else if (value) {
                        encodedParams.push(`${key}=${encodeURIComponent(value)}`);
                    } else {
                        encodedParams.push(key);
                    }
                }
                return `${evaluatedBase}?${encodedParams.join('&')}`;
            } catch (e) {
                console.error('Error encoding URL:', e);
                return evaluateTemplate(url, context);
            }
        }

        // Test the template evaluation
        const testContext = {
            formId: 'test-redirect-template',
            version: 1,
            submittedAt: Date.now(),
            submissionId: 1,
            answers: {
                name: 'John Doe',
                email: 'john@example.com'
            },
            meta: {
                locale: 'en',
                device: 'web',
                sessionId: 'test-session-123'
            },
            name: 'John Doe',
            email: 'john@example.com'
        };

        const templateURL = 'https://www.example.com/booking?formSubmissionId={{.submissionId}}&formId={{.formId}}&name={{.name}}&email={{.email}}';
        const result = encodeTemplateInURL(templateURL, testContext);
        
        console.log('Template URL:', templateURL);
        console.log('Evaluated URL:', result);
        console.log('Expected:', 'https://www.example.com/booking?formSubmissionId=1&formId=test-redirect-template&name=John%20Doe&email=john%40example.com');
        
        document.body.innerHTML = `
            <h1>Redirect Template Test</h1>
            <h2>Template URL:</h2>
            <pre>${templateURL}</pre>
            <h2>Evaluated URL:</h2>
            <pre>${result}</pre>
            <h2>Expected:</h2>
            <pre>https://www.example.com/booking?formSubmissionId=1&formId=test-redirect-template&name=John%20Doe&email=john%40example.com</pre>
            <h2>Test Result:</h2>
            <p style="color: ${result === 'https://www.example.com/booking?formSubmissionId=1&formId=test-redirect-template&name=John%20Doe&email=john%40example.com' ? 'green' : 'red'}">
                ${result === 'https://www.example.com/booking?formSubmissionId=1&formId=test-redirect-template&name=John%20Doe&email=john%40example.com' ? '✅ PASS' : '❌ FAIL'}
            </p>
        `;
    </script>
</head>
<body>
    <p>Loading test...</p>
</body>
</html>


