<!DOCTYPE html>
<html>
<head>
    <title>Test Form Submission ID</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; max-width: 1200px; margin: 0 auto; }
        .section { border: 2px solid #ddd; padding: 20px; margin: 20px 0; border-radius: 8px; }
        .info { background: #e7f3ff; padding: 15px; border-left: 4px solid #2196F3; margin: 15px 0; }
        .success { background: #d4edda; padding: 15px; border-left: 4px solid #28a745; margin: 15px 0; }
        .error { background: #f8d7da; padding: 15px; border-left: 4px solid #dc3545; margin: 15px 0; }
        code { background: #f4f4f4; padding: 2px 6px; border-radius: 3px; display: block; margin: 10px 0; word-break: break-all; }
        button { padding: 10px 20px; margin: 10px 5px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #0056b3; }
        input { padding: 8px; margin: 5px; width: 300px; }
        .log { background: #f8f9fa; padding: 15px; border-radius: 4px; max-height: 400px; overflow-y: auto; font-family: monospace; font-size: 12px; }
    </style>
</head>
<body>
    <h1>üîç Test Form Submission ID in Redirect URL</h1>
    
    <div class="info">
        <strong>Instructions:</strong>
        <ol>
            <li>Enter the form ID below</li>
            <li>Click "Load Form" to fetch the form configuration</li>
            <li>Check the redirect URL configuration</li>
            <li>Click "Test Submission" to simulate a form submission</li>
            <li>Check the console logs and results below</li>
        </ol>
    </div>

    <div class="section">
        <h2>Form Configuration</h2>
        <label>
            Form ID:
            <input type="text" id="formId" value="b97dd1d3-01d2-4c1f-81d8-64b4a20948d7" />
        </label>
        <br>
        <label>
            API Base URL:
            <input type="text" id="apiBase" value="http://localhost:8080" />
        </label>
        <br>
        <button onclick="loadForm()">Load Form</button>
        <button onclick="testSubmission()">Test Submission</button>
    </div>

    <div id="formConfig" class="section" style="display: none;">
        <h2>Form Configuration</h2>
        <div id="configDisplay"></div>
    </div>

    <div id="testResults" class="section" style="display: none;">
        <h2>Test Results</h2>
        <div id="resultsDisplay"></div>
    </div>

    <div class="section">
        <h2>Console Logs</h2>
        <div id="consoleLog" class="log"></div>
    </div>

    <script>
        let formConfig = null;
        let capturedRedirectUrl = null;

        // Override console.log to capture logs
        const originalLog = console.log;
        const originalError = console.error;
        const logDiv = document.getElementById('consoleLog');
        
        function addLog(message, type = 'log') {
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? '#dc3545' : '#007bff';
            logDiv.innerHTML += `<div style="color: ${color};">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        console.log = function(...args) {
            originalLog.apply(console, args);
            addLog(args.join(' '), 'log');
        };

        console.error = function(...args) {
            originalError.apply(console, args);
            addLog(args.join(' '), 'error');
        };

        // Intercept window.location.href to capture redirect URL
        let originalLocationHref = Object.getOwnPropertyDescriptor(window, 'location') || 
                                   Object.getOwnPropertyDescriptor(Object.getPrototypeOf(window), 'location');
        
        Object.defineProperty(window, 'location', {
            get: function() {
                return {
                    ...originalLocationHref.get(),
                    set href(url) {
                        console.log('[REDIRECT CAPTURED] URL:', url);
                        capturedRedirectUrl = url;
                        document.getElementById('testResults').style.display = 'block';
                        displayResults(url);
                    },
                    get href() {
                        return originalLocationHref.get().href;
                    }
                };
            },
            configurable: true
        });

        async function loadForm() {
            const formId = document.getElementById('formId').value;
            const apiBase = document.getElementById('apiBase').value;
            
            console.log(`Loading form: ${formId}`);
            
            try {
                const response = await fetch(`${apiBase}/api/forms/${formId}/latest`);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                formConfig = await response.json();
                console.log('Form loaded:', formConfig);
                
                displayFormConfig(formConfig);
            } catch (error) {
                console.error('Error loading form:', error);
                alert('Error loading form: ' + error.message);
            }
        }

        function displayFormConfig(config) {
            const configDiv = document.getElementById('configDisplay');
            const submitConfig = config.submit || {};
            const redirectAction = submitConfig.actions?.find(a => a.type === 'redirect');
            
            let html = `
                <h3>Form Details</h3>
                <p><strong>Form ID:</strong> ${config.formId}</p>
                <p><strong>Version:</strong> ${config.version}</p>
                
                <h3>Submit Configuration</h3>
                <p><strong>Ordering:</strong> ${(submitConfig.ordering || []).join(' ‚Üí ')}</p>
            `;
            
            if (redirectAction) {
                html += `
                    <h3>Redirect Action</h3>
                    <p><strong>Enabled:</strong> ${redirectAction.enabled ? '‚úÖ Yes' : '‚ùå No'}</p>
                    <p><strong>Redirect URL:</strong></p>
                    <code>${redirectAction.url || '(not set)'}</code>
                `;
                
                if (redirectAction.url && redirectAction.url.includes('{{.submissionId}}')) {
                    html += `
                        <div class="success">
                            ‚úÖ Redirect URL contains {{.submissionId}} template placeholder
                        </div>
                    `;
                } else if (redirectAction.url) {
                    html += `
                        <div class="info">
                            ‚ÑπÔ∏è Redirect URL does not contain {{.submissionId}} template placeholder
                        </div>
                    `;
                }
                
                // Check if server_persist runs before redirect
                const ordering = submitConfig.ordering || [];
                const serverPersistIndex = ordering.indexOf('server_persist');
                const redirectIndex = ordering.indexOf('redirect');
                
                if (serverPersistIndex !== -1 && redirectIndex !== -1) {
                    if (serverPersistIndex < redirectIndex) {
                        html += `
                            <div class="success">
                                ‚úÖ server_persist runs before redirect - submissionId will be available
                            </div>
                        `;
                    } else {
                        html += `
                            <div class="error">
                                ‚ö†Ô∏è redirect runs before server_persist - submissionId will be undefined!
                            </div>
                        `;
                    }
                }
            } else {
                html += `
                    <div class="info">
                        ‚ÑπÔ∏è No redirect action configured
                    </div>
                `;
            }
            
            configDiv.innerHTML = html;
            document.getElementById('formConfig').style.display = 'block';
        }

        async function testSubmission() {
            if (!formConfig) {
                alert('Please load the form first');
                return;
            }

            const apiBase = document.getElementById('apiBase').value;
            const formId = formConfig.formId;
            const version = formConfig.version;
            
            console.log('\n=== Starting Form Submission Test ===');
            console.log('Form ID:', formId);
            console.log('Version:', version);
            
            // Create a minimal payload
            const payload = {
                formId: formId,
                version: version,
                submittedAt: Date.now(),
                answers: {},
                meta: {
                    locale: 'en',
                    device: 'web'
                }
            };
            
            console.log('Payload:', payload);
            
            try {
                // Step 1: Submit to server_persist
                console.log('\n--- Step 1: server_persist ---');
                const submitResponse = await fetch(`${apiBase}/api/submissions`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!submitResponse.ok) {
                    throw new Error(`Submission failed: ${submitResponse.status}`);
                }
                
                const submitData = await submitResponse.json();
                const submissionId = submitData.id || submitData.submissionId;
                
                console.log('Submission ID received:', submissionId);
                
                // Step 2: Simulate redirect with submissionId
                console.log('\n--- Step 2: Simulating redirect ---');
                const submitConfig = formConfig.submit || {};
                const redirectAction = submitConfig.actions?.find(a => a.type === 'redirect' && a.enabled);
                
                if (!redirectAction || !redirectAction.url) {
                    console.log('No redirect action configured or enabled');
                    return;
                }
                
                const redirectUrl = redirectAction.url;
                console.log('Redirect URL template:', redirectUrl);
                
                // Simulate the redirect function
                if (redirectUrl.includes('{{')) {
                    const context = {
                        formId: formId,
                        version: version,
                        submittedAt: payload.submittedAt,
                        submissionId: submissionId,
                        answers: payload.answers,
                        meta: payload.meta
                    };
                    
                    // Use the same logic as encodeTemplateInURL
                    const urlObj = new URL(redirectUrl);
                    const existingParams = new URLSearchParams(urlObj.search);
                    const newParams = new URLSearchParams();
                    
                    existingParams.forEach((value, key) => {
                        let evaluatedValue = value;
                        if (value.includes('{{')) {
                            // Simple template replacement
                            evaluatedValue = value.replace(/\{\{\.(\w+)\}\}/g, (match, varName) => {
                                return context[varName] != null ? String(context[varName]) : '';
                            });
                        }
                        newParams.append(key, evaluatedValue);
                    });
                    
                    const resultUrl = new URL(urlObj.pathname, urlObj.origin);
                    newParams.forEach((value, key) => {
                        resultUrl.searchParams.append(key, value);
                    });
                    
                    const finalUrl = resultUrl.toString();
                    console.log('Final redirect URL:', finalUrl);
                    
                    // Check if submissionId is in the URL
                    const urlParams = new URLSearchParams(resultUrl.search);
                    const urlSubmissionId = urlParams.get('submissionId') || urlParams.get('formSubmissionId');
                    
                    displayResults(finalUrl, submissionId, urlSubmissionId);
                } else {
                    console.log('No template placeholders in redirect URL');
                    displayResults(redirectUrl, submissionId, null);
                }
                
            } catch (error) {
                console.error('Error during test:', error);
                alert('Error: ' + error.message);
            }
        }

        function displayResults(finalUrl, actualSubmissionId, urlSubmissionId) {
            const resultsDiv = document.getElementById('resultsDisplay');
            
            let html = `
                <h3>Test Results</h3>
                <p><strong>Actual Submission ID:</strong> ${actualSubmissionId || '(not available)'}</p>
                <p><strong>Final Redirect URL:</strong></p>
                <code>${finalUrl}</code>
            `;
            
            if (urlSubmissionId) {
                if (urlSubmissionId === String(actualSubmissionId)) {
                    html += `
                        <div class="success">
                            ‚úÖ SUCCESS! Submission ID correctly added to redirect URL<br>
                            Expected: ${actualSubmissionId}<br>
                            Found in URL: ${urlSubmissionId}
                        </div>
                    `;
                } else {
                    html += `
                        <div class="error">
                            ‚ùå MISMATCH! Submission ID in URL doesn't match<br>
                            Expected: ${actualSubmissionId}<br>
                            Found in URL: ${urlSubmissionId}
                        </div>
                    `;
                }
            } else {
                html += `
                    <div class="info">
                        ‚ÑπÔ∏è No submissionId found in redirect URL parameters
                    </div>
                `;
            }
            
            // Check for encoding issues
            if (finalUrl.includes('%3F') || finalUrl.includes('%3D')) {
                html += `
                    <div class="error">
                        ‚ö†Ô∏è ENCODING ISSUE DETECTED!<br>
                        Found %3F (encoded ?) or %3D (encoded =) in URL
                    </div>
                `;
            }
            
            // Parse and display all query parameters
            try {
                const url = new URL(finalUrl);
                const params = Object.fromEntries(url.searchParams);
                html += `
                    <h3>Query Parameters:</h3>
                    <pre style="background: #f4f4f4; padding: 15px; border-radius: 4px;">${JSON.stringify(params, null, 2)}</pre>
                `;
            } catch (e) {
                // Relative URL
                if (finalUrl.includes('?')) {
                    const [, query] = finalUrl.split('?');
                    const params = Object.fromEntries(new URLSearchParams(query));
                    html += `
                        <h3>Query Parameters:</h3>
                        <pre style="background: #f4f4f4; padding: 15px; border-radius: 4px;">${JSON.stringify(params, null, 2)}</pre>
                    `;
                }
            }
            
            resultsDiv.innerHTML = html;
            document.getElementById('testResults').style.display = 'block';
        }
    </script>
</body>
</html>

