<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Native Bridge Test</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 800px;
      margin: 40px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    h1 {
      margin-top: 0;
      color: #333;
    }
    .instructions {
      background: #f0f0f0;
      padding: 15px;
      border-radius: 4px;
      margin-bottom: 20px;
    }
    .bridge-selector {
      margin: 20px 0;
    }
    .bridge-selector label {
      display: block;
      margin: 10px 0;
      cursor: pointer;
    }
    .bridge-selector input[type="radio"] {
      margin-right: 8px;
    }
    #log {
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 15px;
      border-radius: 4px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      max-height: 400px;
      overflow-y: auto;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    .log-entry {
      margin: 5px 0;
    }
    .log-info { color: #4ec9b0; }
    .log-success { color: #4ec9b0; }
    .log-error { color: #f48771; }
    .log-payload { color: #dcdcaa; }
    button {
      background: #2E4BFF;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      margin: 5px;
    }
    button:hover {
      background: #1e3aef;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ðŸŒ‰ Native Bridge Test</h1>
    
    <div class="instructions">
      <h3>How to Test:</h3>
      <ol>
        <li>Select a bridge type below (React Native, iOS, or Android)</li>
        <li>Click "Setup Bridge Mock" to inject the mock bridge into the page</li>
        <li>Open a form page (with native_bridge enabled) in a new tab</li>
        <li>Submit the form and watch the logs here</li>
        <li>Or use the "Test Bridge Directly" button to simulate a form submission</li>
      </ol>
    </div>

    <div class="bridge-selector">
      <h3>Select Bridge Type:</h3>
      <label>
        <input type="radio" name="bridge" value="react-native" checked>
        React Native WebView (window.ReactNativeWebView.postMessage)
      </label>
      <label>
        <input type="radio" name="bridge" value="ios">
        iOS WKWebView (window.webkit.messageHandlers.bridge.postMessage)
      </label>
      <label>
        <input type="radio" name="bridge" value="android">
        Android Interface (window.AndroidBridge.postMessage)
      </label>
    </div>

    <div>
      <button onclick="setupBridge()">Setup Bridge Mock</button>
      <button onclick="testBridge()">Test Bridge Directly</button>
      <button onclick="clearLog()">Clear Log</button>
    </div>

    <div style="margin-top: 20px;">
      <h3>Bridge Status:</h3>
      <div id="status"></div>
    </div>

    <div style="margin-top: 20px;">
      <h3>Log:</h3>
      <div id="log"></div>
    </div>
  </div>

  <script>
    let logMessages = [];

    function log(message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString();
      const entry = `[${timestamp}] ${message}`;
      logMessages.push({ entry, type });
      updateLog();
      console.log(`[Native Bridge Test] ${message}`);
    }

    function updateLog() {
      const logEl = document.getElementById('log');
      logEl.innerHTML = logMessages.map(m => 
        `<div class="log-entry log-${m.type}">${m.entry}</div>`
      ).join('');
      logEl.scrollTop = logEl.scrollHeight;
    }

    function updateStatus() {
      const statusEl = document.getElementById('status');
      const bridgeType = document.querySelector('input[name="bridge"]:checked').value;
      
      let status = '';
      if (bridgeType === 'react-native') {
        status = window.ReactNativeWebView 
          ? 'âœ… React Native bridge is active' 
          : 'âŒ React Native bridge not found';
      } else if (bridgeType === 'ios') {
        status = window.webkit?.messageHandlers?.bridge 
          ? 'âœ… iOS bridge is active' 
          : 'âŒ iOS bridge not found';
      } else if (bridgeType === 'android') {
        status = window.AndroidBridge 
          ? 'âœ… Android bridge is active' 
          : 'âŒ Android bridge not found';
      }
      
      statusEl.innerHTML = status;
    }

    function setupBridge() {
      const bridgeType = document.querySelector('input[name="bridge"]:checked').value;
      
      // Clear existing bridges
      delete window.ReactNativeWebView;
      delete window.webkit;
      delete window.AndroidBridge;

      if (bridgeType === 'react-native') {
        window.ReactNativeWebView = {
          postMessage: function(message) {
            try {
              const data = JSON.parse(message);
              log('ðŸ“¨ React Native bridge received message:', 'success');
              log(`Type: ${data.type}`, 'info');
              log(`Payload: ${JSON.stringify(data.payload, null, 2)}`, 'payload');
              
              // Simulate acknowledgment
              if (data.payload && !data.payload.bridgeAck) {
                setTimeout(() => {
                  log('âœ… Bridge acknowledgment sent', 'success');
                }, 100);
              }
            } catch (e) {
              log(`âŒ Error parsing message: ${e.message}`, 'error');
            }
          }
        };
        log('âœ… React Native bridge mock installed', 'success');
      } else if (bridgeType === 'ios') {
        window.webkit = {
          messageHandlers: {
            bridge: {
              postMessage: function(data) {
                log('ðŸ“¨ iOS bridge received message:', 'success');
                log(`Type: ${data.type}`, 'info');
                log(`Payload: ${JSON.stringify(data.payload, null, 2)}`, 'payload');
                
                // Simulate acknowledgment
                if (data.payload && !data.payload.bridgeAck) {
                  setTimeout(() => {
                    log('âœ… Bridge acknowledgment sent', 'success');
                  }, 100);
                }
              }
            }
          }
        };
        log('âœ… iOS bridge mock installed', 'success');
      } else if (bridgeType === 'android') {
        window.AndroidBridge = {
          postMessage: function(message) {
            try {
              const data = JSON.parse(message);
              log('ðŸ“¨ Android bridge received message:', 'success');
              log(`Type: ${data.type}`, 'info');
              log(`Payload: ${JSON.stringify(data.payload, null, 2)}`, 'payload');
              
              // Simulate acknowledgment
              if (data.payload && !data.payload.bridgeAck) {
                setTimeout(() => {
                  log('âœ… Bridge acknowledgment sent', 'success');
                }, 100);
              }
            } catch (e) {
              log(`âŒ Error parsing message: ${e.message}`, 'error');
            }
          }
        };
        log('âœ… Android bridge mock installed', 'success');
      }

      updateStatus();
    }

    function testBridge() {
      const bridgeType = document.querySelector('input[name="bridge"]:checked').value;
      
      if (bridgeType === 'react-native' && !window.ReactNativeWebView) {
        alert('Please setup the bridge first!');
        return;
      }
      if (bridgeType === 'ios' && !window.webkit?.messageHandlers?.bridge) {
        alert('Please setup the bridge first!');
        return;
      }
      if (bridgeType === 'android' && !window.AndroidBridge) {
        alert('Please setup the bridge first!');
        return;
      }

      // Simulate a form submission payload
      const mockPayload = {
        formId: 'test-form',
        version: 1,
        submittedAt: Date.now(),
        answers: {
          name: 'John Doe',
          email: 'john@example.com',
          phone_number: { e164: '+96550000000', country: 'KW' },
          contact_pref: { value: 'email' }
        },
        meta: {
          locale: 'en',
          device: 'web',
          attributes: []
        }
      };

      log('ðŸ§ª Testing bridge with mock payload...', 'info');
      
      if (bridgeType === 'react-native') {
        window.ReactNativeWebView.postMessage(JSON.stringify({
          type: 'form_submit',
          payload: mockPayload
        }));
      } else if (bridgeType === 'ios') {
        window.webkit.messageHandlers.bridge.postMessage({
          type: 'form_submit',
          payload: mockPayload
        });
      } else if (bridgeType === 'android') {
        window.AndroidBridge.postMessage(JSON.stringify({
          type: 'form_submit',
          payload: mockPayload
        }));
      }
    }

    function clearLog() {
      logMessages = [];
      updateLog();
    }

    // Update status on bridge type change
    document.querySelectorAll('input[name="bridge"]').forEach(radio => {
      radio.addEventListener('change', updateStatus);
    });

    // Initial status update
    updateStatus();
    log('Ready to test native bridge. Select a bridge type and click "Setup Bridge Mock"', 'info');
  </script>
</body>
</html>

